<template>
  <q-page class="flex flex-center bg-grey-10 text-white">
    <!-- 地图容器 -->
    <div id="map" style="z-index:0"></div>
  </q-page>
</template>


<script>
import L from "leaflet"
import "leaflet/dist/leaflet.css"
import { defineComponent, createApp } from "vue";
import emitter from '/utils/emitter'
import 'leaflet-rotatedmarker'

export default defineComponent({
  name: 'IndexPage',
  data() {
    return {
      idx: 0,
      angle: 0,
      marker1: null,
      marker2: null,
      flag: true,
      map: null,
      marker: [],
      points: [],
      ship_pos: [],
      my_ship_pos: [],
      pick_points: [],
      picking: false,
      emitter: emitter,
      marker_group: null,
      polyline_group: null,
    }
  },
  mounted() {
    this.initMap();
    setTimeout(() => {
      emitter.emit('BMapLoad');
    }, 1000);
    this.eventReady();

    setInterval(() => {
      this.idx = (this.idx + 1) % 39;  // 当前点
      let idx1 = (this.idx + 1) % 39;  // 下一个点
      let dx = this.my_ship_pos[idx1][1] - this.my_ship_pos[this.idx][1];
      let dy = this.my_ship_pos[idx1][0] - this.my_ship_pos[this.idx][0];
      let t = Math.atan2(dy, dx);
      if (t < 0) t += 2 * Math.PI;
      this.marker2.setRotationAngle(this.angle); // 恢复箭头的方向
      this.angle = 360 * t / (2 * Math.PI);

      const r = 0.0007;
      let a = r * Math.sin(t) + this.my_ship_pos[this.idx][0];
      let b = r * Math.cos(t) + this.my_ship_pos[this.idx][1];

      this.marker2.setRotationAngle(-this.angle).setLatLng([a, b]);
      this.marker1.setLatLng(this.my_ship_pos[this.idx]);

    }, 10000);  // 10秒更新一次船的位置

    setInterval(() => {
      if (this.flag) {
        this.map.removeLayer(this.marker2);
        this.flag = false;
      }
      else {
        this.map.addLayer(this.marker2);
        this.flag = true;
      }
    }, 600); // 设置箭头闪烁效果
  },
  methods: {
    // 使用id为map的div容器初始化地图，同时指定地图的中心点和缩放级别
    initMap() {
      let map = L.map("map", {
        center: [28.866212, 105.440566], // 中心位置
        zoom: 16, // 缩放等级
        attributionControl: true, // 版权控件
        zoomControl: true //缩放控件
      });
      this.map = map; // data上需要挂载

      // L.tileLayer(
      //   "http://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}"
      // ).addTo(this.map);

      L.tileLayer.wms(
        "http://127.0.0.1:8080/geoserver/wms?", {
        layers: "cite:merge",
        format: 'image/png',
        transparent: true,
      }).addTo(this.map);

      L.tileLayer.wms(
        "http://127.0.0.1:8080/geoserver/wms?", {
        layers: "cite:merge1",
        format: 'image/png',
        transparent: true,
      }).addTo(this.map);

      this.init_ship_pos();
      this.init_my_ship();
      this.init_arrow();
      this.init_icon();
    },

    click_callback: function (e) {
      if (this.picking == false) return;
      if (this.marker_group) {
        this.marker_group.clearLayers();
      }
      if (this.polyline_group) {
        this.map.removeLayer(this.polyline_group);
      }

      var lng = e.latlng.lng, lat = e.latlng.lat;
      this.marker.push(L.marker([lat, lng]));
      this.pick_points.push(L.point([lng, lat]));
      this.points.push([lat, lng]);

      this.marker_group = L.layerGroup(this.marker).addTo(this.map);
      if (this.points.length > 1) {
        this.polyline_group = L.polyline(this.points, { color: 'red' }).addTo(this.map);
      }
    },

    init_ship_pos: function () {
      this.ship_pos = [
        [28.759382670867545, 105.20691991851767],
        [28.754378871542464, 105.2153731279284],
        [28.752046191410834, 105.22219576902636],
        [28.753927389132212, 105.22378342764665],
        [28.74764405631306, 105.22858931319996],
        [28.749450082902793, 105.23330937936836],
        [28.743994282259887, 105.23468248952648],
        [28.745875625017153, 105.2396171041571],
        [28.742940715515587, 105.24008911077394],
        [28.73996809492057, 105.24532409325164],
        [28.737334056630626, 105.24819904264515],
        [28.736280422722146, 105.25141726957814],
        [28.738199533679108, 105.25459258681872],
        [28.734323645849173, 105.26476218392706],
        [28.73605464264526, 105.26102904068476],
        [28.738350050694894, 105.27046917302161],
        [28.741586114088513, 105.27527505857493],
        [28.73993046626967, 105.27707726565741],
        [28.744332926456824, 105.28158278336362],
        [28.7452735990214, 105.27892238243236],
        [28.74482207724756, 105.28776177907501],
        [28.74768168218553, 105.28634575922449],
        [28.751632323364152, 105.28995017338947],
        [28.751782821025476, 105.29578589156134],
        [28.755168961063113, 105.29647244664034],
        [28.762392359461288, 105.30449655912669],
        [28.76167756627739, 105.30222234542738],
        [28.762542841613133, 105.30325217804592],
        [28.760737041472936, 105.30479692697376],
        [28.76118849443662, 105.30707114067309],
        [28.760135101150944, 105.31736946685874],
        [28.761113252411583, 105.32590849565435],
        [28.76487528722506, 105.33530571829876],
        [28.758855966442397, 105.31230612315078],
        [28.76844909470266, 105.3425145466287],
        [28.77198516269517, 105.3480498969535],
        [28.77021714367722, 105.35169722081092],
        [28.774355013536248, 105.35345651820096],
        [28.775972499868434, 105.36105153376286],
        [28.780298212186658, 105.36175711279427],
        [28.78319445842991, 105.36849393450734],
        [28.78436045693709, 105.36669172742486],
        [28.78943804036672, 105.37098346531346],
        [28.795944508048073, 105.366263399145],
        [28.803277900949332, 105.36647794760721],
        [28.800419819438915, 105.36896670976873],
        [28.80564704067525, 105.35300430418101],
        [28.801623231733885, 105.36107132635973],
        [28.812114893886168, 105.35369085926003],
        [28.822267109307035, 105.35064427109677],
        [28.82335747358648, 105.3476835023184],
        [28.82869633383384, 105.34798387016549],
        [28.834260488325203, 105.35167410371534],
        [28.839410825670793, 105.35742400250233],
        [28.839861937967964, 105.35424868526177],
        [28.844598499001957, 105.35978403558654],
        [28.84786885576399, 105.36592012160551],
        [28.853582335767495, 105.37171322397843],
        [28.85696516939728, 105.37553218660561],
        [28.85576239671519, 105.37965151707985],
        [28.861700951582257, 105.38209736954893],
        [28.860460648527514, 105.38896292033937],
        [28.86256539647543, 105.3959142905147],
        [28.86312916101117, 105.40432459023297],
        [28.863317081843633, 105.40934502424847],
        [28.864670101808542, 105.41527318571259],
        [28.863392250081507, 105.4164746571009],
        [28.864632518158444, 105.42029361972808],
        [28.866436518034053, 105.42896137760103],
        [28.868127739480244, 105.43750040639658],
        [28.869931678688708, 105.44771291319736],
        [28.872975755095634, 105.45243297936575],
        [28.877372596912178, 105.4528231398118],
        [28.883610531815393, 105.45672792182384],
        [28.889246897776193, 105.45750029628779],
        [28.887894197844982, 105.45801521259706],
        [28.886541480292735, 105.45913086460051],
        [28.886278449833558, 105.4579293932122],
        [28.88691723693586, 105.45694247028602],
        [28.898903160324508, 105.45278023011936],
        [28.90314862571331, 105.45170748780833],
        [28.908107710485336, 105.45342387550593],
        [28.910662298023883, 105.46003196814175],
        [28.91186443510049, 105.46591059600605],
        [28.910098791474024, 105.46835644847516],
        [28.911376068593142, 105.47140303663839],
        [28.907694462473106, 105.47187504325527],
        [28.90532764669644, 105.4750503604958],
        [28.90799500664524, 105.47693838696317],
        [28.9038248785011, 105.47921558481191],
        [28.899278872230283, 105.48058869497001],
        [28.892515849858796, 105.482734179592],
        [28.89503324855306, 105.48848407837899],
        [28.892816437986678, 105.48882735591849],
        [28.89322974524155, 105.48749715545289],
        [28.890524431530938, 105.48942809161268],
        [28.891614080253618, 105.48874153653364],
        [28.891538932432997, 105.4880549814546],
        [28.888420249912105, 105.48929936253536],
        [28.88984809208934, 105.48856989776387],
        [28.886691783113125, 105.48616695498721],
        [28.887180265777076, 105.487025148836],
        [28.88887114956286, 105.48509421267622],
        [28.88199471715837, 105.48728260699069],
        [28.878988483469275, 105.49131611808005],
        [28.87432864931871, 105.49028628546147],
        [28.873501882720014, 105.49200267315908],
        [28.872712690284406, 105.49423397716596],
        [28.871660424379538, 105.49633655209556],
        [28.873313980302836, 105.49410524808864],
        [28.87432864931871, 105.49371906085669],
        [28.87432864931871, 105.49251758946835],
        [28.87515540933867, 105.49144484715735],
        [28.876470695811673, 105.49882531425709],
        [28.873088496953688, 105.50290173503889],
        [28.872787851726986, 105.50942400828981],
        [28.87560636657665, 105.51817758554763],
        [28.873539463162686, 105.5149593586146],
        [28.87718470149525, 105.52439949095145],
        [28.880228565408345, 105.53062139635524],
        [28.883798415609228, 105.5388600573038],
        [28.885414202205716, 105.54031898684676],
        [28.89071230281621, 105.54091972254089],
        [28.893304891838365, 105.54606888563374],
        [28.895822271399737, 105.54971620949115],
        [28.898640161181277, 105.55555192766302],
        [28.900556282537163, 105.56018617444657],
        [28.91047446284732, 105.5648204212301],
        [28.91366761459632, 105.56233165906858],
        [28.922119600644127, 105.55902761275067],
        [28.916334760129303, 105.55602393427984],
        [28.91768708940788, 105.55486537258398],
        [28.91652258469462, 105.55546610827813],
        [28.918212990476594, 105.55366390119565],
        [28.9293314173728, 105.54242156177632],
        [28.927340705588193, 105.54383758162685],
        [28.9316601260391, 105.54696998917497],
        [28.935491113561746, 105.55332062365613],
        [28.938608381265936, 105.54027607715432],
        [28.945556170634738, 105.54843825548838],
        [28.954418620221336, 105.55590454197295],
        [28.958887110165133, 105.56328500907267],
        [28.964256553063233, 105.57478480664668],
        [28.964106362642298, 105.57298259956418],
        [28.963918624309706, 105.57152367002121],
        [28.963355407269024, 105.57053674709508],
        [28.964932407260807, 105.57482771633912],
        [28.961440446410187, 105.5811354411278],
        [28.961815931723347, 105.57753102696283],
        [28.95824876626496, 105.59083303161931],
        [28.961740834769667, 105.59031811531],
        [28.96211631899335, 105.58920246330658],
        [28.96222896399489, 105.58830135976531],
        [28.952841460085725, 105.59756985333239],
        [28.946419917291045, 105.60100262872761],
        [28.94078665725708, 105.60559396581874],
        [28.93534088142455, 105.61053809242554],
        [28.931472328892433, 105.62349681954247],
        [28.930908935411015, 105.6251273878552],
        [28.930082619432618, 105.62731578216966],
        [28.929256296867443, 105.62989036371604],
        [28.9316601260391, 105.62233825784658],
        [28.929894819428, 105.62401173585175],
        [28.929406537823755, 105.62607140108888],
        [28.92835484655698, 105.62847434386555],
        [28.928843133114825, 105.63207875803049],
        [28.927566071105243, 105.63087728664219],
        [28.92166884544315, 105.63787156650994],
        [28.91614693522387, 105.6437072846818],
        [28.906905529879428, 105.64448502270211],
        [28.896724004452555, 105.64105224730689],
        [28.895671981796077, 105.64598686193752],
        [28.895108393844453, 105.64495702931893],
        [28.8948829578071, 105.64324064162133],
        [28.892515849858796, 105.6441417451626],
        [28.896423427638616, 105.64512866808869],
        [28.89755058620314, 105.64482830024163],
        [28.890900173761544, 105.63247030881882],
        [28.88575238691662, 105.62504693202669],
        [28.878236911452962, 105.62246780078283],
        [28.87594458322063, 105.61976449015907],
        [28.871923491854748, 105.62366927217111],
        [28.864519767126602, 105.62804606080005],
        [28.863204329384917, 105.62778860264542],
        [28.861588197370597, 105.63006281634473],
        [28.861362688580346, 105.6331952238929],
        [28.860385478169814, 105.63473997282073],
        [28.860798914464546, 105.63795819975373],
        [28.862001628882183, 105.64027532314552],
        [28.865008354047916, 105.62645840217976],
        [28.86771433233479, 105.64079023945477],
        [28.869856515180192, 105.6358985345166],
        [28.87064572930805, 105.63177920404235],
        [28.86658684994367, 105.63521197943759],
        [28.870908799352055, 105.64551030562319],
        [28.87320123868943, 105.66147271121095],
        [28.86801499224003, 105.65430679257344],
        [28.87320123868943, 105.67554709033135],
        [28.867789497392643, 105.67490344494476],
        [28.871096706118603, 105.68773344298435],
        [28.874929929985676, 105.70137872518033],
        [28.872186558663977, 105.70060635071643],
        [28.878349647602047, 105.7091024698196],
        [28.88346022453561, 105.71889865275959],
        [28.88774389676489, 105.72048631137989],
        [28.886654207428432, 105.71971393691598],
        [28.885639658802024, 105.71868410429741],
        [28.884549947385725, 105.71774009106373],
        [28.883723262132488, 105.71640989059807],
        [28.89326731854675, 105.72709440401569],
        [28.895559264450508, 105.73172865079925],
        [28.904876818522897, 105.73713527204671],
        [28.908370685636143, 105.74318553868076],
        [28.911037967356684, 105.74305680960344],
        [28.91569615406313, 105.75562934948843],
        [28.91701092697263, 105.76322436505035],
        [28.915808849536965, 105.76798734091122],
        [28.91517024023286, 105.76266653904862],
        [28.912841161218115, 105.77777843723297],
        [28.908596092377763, 105.7855021818722],
        [28.898978302814466, 105.78511804059113],
        [28.89086259959968, 105.78799298998464],
        [28.889246897776193, 105.78812171906196],
        [28.888532975008356, 105.78734934459801],
        [28.88984809208934, 105.78713479613582],
        [28.885977842778754, 105.78717770582826],
        [28.886842085716015, 105.78825044813927],
        [28.88447479445278, 105.78863663537123],
        [28.877673228872403, 105.78494722698392],
        [28.856100677938294, 105.79129777103628],
        [28.85444684816359, 105.79181268734555],
        [28.85268022821327, 105.79344325565829],
        [28.850988755457102, 105.79550292089542],
        [28.853131282968583, 105.79245633273216],
        [28.85354474810896, 105.79104031288162],
        [28.854935482425653, 105.79035375780259],
        [28.847041878709184, 105.79554583058786],
        [28.843132443630058, 105.80215392322367],
        [28.838734153557887, 105.81047840355704],
        [28.83181680845661, 105.82082430782036],
        [28.826966873874856, 105.82674584537712],
        [28.815950291579366, 105.83610229470875],
        [28.82294388847978, 105.82820691129973],
        [28.821477528045765, 105.82970875053515],
        [28.81937194874498, 105.83125349946297],
        [28.82001114696181, 105.83078149284616],
        [28.82230470826537, 105.82992329899734],
        [28.812077291248947, 105.83777577271393],
        [28.807865709986338, 105.84395476842529],
        [28.805421410641134, 105.84811700859198],
        [28.808730602173302, 105.85777168939104],
        [28.813694192392887, 105.86180520048042],
        [28.81734152838436, 105.8661819891093],
        [28.82313188191377, 105.86927148696502],
        [28.8207631398408, 105.87180315881895],
        [28.819559948627813, 105.87386282405612],
        [28.821477528045765, 105.87875452899428],
        [28.8247110133585, 105.87746723822112],
        [28.822643098279425, 105.88343168547028],
        [28.823019085894103, 105.88467606655107],
        [28.823883852255403, 105.88656409301842],
        [28.824598219049562, 105.8880659322538],
        [28.825350178800807, 105.88935322302702],
        [28.82516218937218, 105.88789429348405],
        [28.8247110133585, 105.88562007978472],
        [28.82362066325359, 105.88450442778127],
        [28.83414770436345, 105.88986813933627],
        [28.840087493383137, 105.89853589720921],
        [28.849372433564202, 105.90669731820236],
        [28.858844473859083, 105.91021591298247],
        [28.866812347400387, 105.9116326901739],
        [28.874366229462336, 105.90819907266079],
        [28.881957139774222, 105.90077569586863],
        [28.884512370926046, 105.8941246935404],
        [28.88639117725477, 105.89433924200259],
        [28.887894197844982, 105.8872162330575],
        [28.889697793837374, 105.88275362504375],
        [28.895559264450508, 105.87670335840971],
        [28.896874292533134, 105.87382840901618],
        [28.898940731576268, 105.87584516456089],
        [28.9010822704468, 105.87571643548355],
        [28.90885906629075, 105.87966412718806],
        [28.913517350835484, 105.87743282318117],
        [28.91381787813948, 105.88416964489429],
        [28.91498241321867, 105.88558566474478],
        [28.916334760129303, 105.88640094890118],
        [28.917574395974793, 105.88644385859362],
        [28.91592154488839, 105.88481329028089],
        [28.9172738795546, 105.88584312289946],
        [28.914644323736066, 105.88361181889253],
        [28.92377235295077, 105.8828778326826],
        [28.928692891341978, 105.88506622699707],
        [28.93286201972084, 105.88463719789425],
        [28.93286201972084, 105.88038913834264],
        [28.937594340616094, 105.87592653032888],
        [28.937293882221663, 105.86738750153326],
        [28.93462727579898, 105.85979248597137],
        [28.931622566636968, 105.84966579855546],
        [28.940260870693095, 105.86777368876521],
        [28.94600682196262, 105.85498660041804],
        [28.946194592770656, 105.85777573042668],
        [28.944992853718126, 105.86013576351087],
        [28.945593724986942, 105.86125141551433],
        [28.94454219797943, 105.86404054552294],
        [28.944917744564474, 105.85841937581326],
        [28.94660768735031, 105.85631680088369],
        [28.9433028845901, 105.8482926883974],
        [28.944504643246045, 105.8461042940829],
        [28.941049549538562, 105.83859509790588],
        [28.944504643246045, 105.83164372773058],
        [28.9538929028449, 105.82396289278378],
        [28.95494433492901, 105.82018683984906],
        [28.96095231346713, 105.82138167602646],
        [28.96703503654451, 105.82116740450232],
        [28.970376627343054, 105.8263594772876],
        [28.97668405524122, 105.83181113895537],
        [28.972967224612812, 105.83571592096743],
        [28.97811068204261, 105.84768772515825],
        [28.981564539145268, 105.8418520069864],
        [28.977772798525375, 105.8393203351324],
        [28.987871284986433, 105.84648775149643],
        [28.987570972476313, 105.85648570983501],
        [28.988809755959657, 105.85970393676797],
        [28.99695532619532, 105.85047871460844],
        [28.999094839602552, 105.85687225878202],
        [29.00633882810143, 105.85060744368576],
        [29.009941866446017, 105.8535682124641],
        [29.015571362329318, 105.85047871460844],
        [29.01812329940613, 105.85451222569783],
        [29.021313132088235, 105.85549914862392],
        [29.024165134354117, 105.85721553632153],
        [29.025516055303772, 105.85601406493323],
        [29.031970211440072, 105.86081995048652],
        [29.034371654907613, 105.86888697266528],
        [29.030244139439894, 105.87004553436114],
        [29.030094044858586, 105.87167610267387],
        [29.029568712105505, 105.87433650360518],
        [29.03043175735966, 105.87407904545056],
        [29.031032132411564, 105.87184774144364],
        [29.03043175735966, 105.86910152112749],
        [29.043414089132387, 105.88077295747121],
        [29.048441489877778, 105.88798178580116],
        [29.053055977892825, 105.89531934320843],
        [29.054856697702927, 105.90201325522912],
        [29.055682017108406, 105.91171681967116],
        [29.055306872742868, 105.91373357521589],
        [29.055119300048375, 105.91609360830009],
        [29.055907103072666, 105.91514959506638],
        [29.057970368186314, 105.92373469290956],
        [29.058570583013324, 105.9384098077241],
        [29.060633794834594, 105.94862231452488],
        [29.058795662672733, 105.95565950408505],
        [29.058495556350998, 105.95754753055245],
        [29.05973348929858, 105.95784789839954],
        [29.05890820231822, 105.96037957025348],
        [29.059283333582695, 105.96213886764353],
        [29.05988354076719, 105.96029375086862],
        [29.062771988976138, 105.95596463639794],
        [29.062471894227834, 105.96583386565916],
        [29.0595459246558, 105.97038229305785],
        [29.06112145705095, 105.9772907535407],
        [29.06112145705095, 105.98471413033288],
        [29.062396870404264, 105.99278115251163],
        [29.06536026992235, 106.00209255577114],
        [29.065697866994075, 106.00372312408388],
        [29.067085754450954, 106.00428095008557],
        [29.068511132928652, 106.00518205362684],
        [29.06956139919416, 106.00492459547222],
        [29.07102425222949, 106.00436676947045],
        [29.071061761008668, 106.00128133525762],
        [29.066785672259858, 105.99986531540709],
        [29.07507512150224, 106.00063768987098],
        [29.077888131476566, 105.9981918374019],
        [29.08531410879644, 105.99660417878162],
        [29.086589222765255, 106.00149588371983],
        [29.09240204230217, 106.00132437494139],
        [29.095627078065526, 106.00540079572322],
        [29.097277057300865, 106.01132233327999],
        [29.096489570509814, 106.01681629989778],
        [29.09757705068449, 106.01724539682222],
        [29.09701456237313, 106.02059235283252],
        [29.097839544178072, 106.01956252021398],
        [29.098627020643033, 106.02574151592535],
        [29.0970520616895, 106.0303757627089],
        [29.097127060281267, 106.03775622980862],
        [29.09420207471904, 106.04462595162602],
        [29.096939563699404, 106.04964638564154],
        [29.0898894444391, 106.05127695395427],
        [29.088614371328703, 106.05359407734602],
        [29.087264276710897, 106.05634029766223],
        [29.085764150823216, 106.05745594966565],
        [29.087114265105324, 106.05582538135289],
        [29.08880188307031, 106.05303625134431],
        [29.090001950132088, 106.05024712133567],
        [29.090976994322702, 106.04913146933225],
        [29.092439543298454, 106.05784213689758],
        [29.093789570069482, 106.05196350903329],
        [29.08801433146131, 106.06917029570182],
        [29.082388787693272, 106.06723935954201],
        [29.078713266501474, 106.07616457556958],
        [29.074062419112177, 106.07998899218191],
        [29.072599609201045, 106.0883134725153],
        [29.066410568292504, 106.09702541738703],
        [29.06521022642449, 106.10011489263555],
        [29.067798446153624, 106.09736867231933],
        [29.06716077486224, 106.09415044538633],
        [29.067348325651544, 106.11032971667352],
        [29.068736190886472, 106.11942657147085],
        [29.07151186529394, 106.12697867734032],
        [29.081338652162124, 106.13551770613589],
        [29.08823934682125, 106.13886466214623],
        [29.085914164395184, 106.13586098367544],
        [29.09281455251034, 106.14054213597267],
        [29.095852076791065, 106.1386970305013],
        [29.10440166398923, 106.14320254820754],
        [29.10462664353666, 106.13685191372637],
        [29.10803877304572, 106.1430309094378],
        [29.10631397446643, 106.14320254820754],
        [29.1160624559092, 106.13500656522771],
        [29.120074062683805, 106.12990031182736],
        [29.1251352124897, 106.12702536243386],
        [29.126109923848166, 106.12063181826025],
        [29.13416968290177, 106.11925564482766],
        [29.134956881309794, 106.11444975927432],
        [29.14020471663216, 106.11372029450283],
        [29.14132921791154, 106.11110280326398],
        [29.14342825404455, 106.11560832097024],
        [29.149575184634347, 106.11556406614983],
        [29.15249859573883, 106.10929925105357],
        [29.157895443807288, 106.11556477827637],
        [29.160968522231688, 106.12264487752901],
        [29.164191408113968, 106.12800858908405],
        [29.15707094370562, 106.11659461089496],
        [29.160218999388512, 106.11985574752042],
        [29.16883818175527, 106.13629345472329],
        [29.175133475015826, 106.14457502536423],
        [29.18270230443126, 106.15195725017314],
        [29.188434759054648, 106.15500383833643],
        [29.196302312391865, 106.15337341131861],
        [29.209525934689268, 106.1508846491571],
        [29.213196779400707, 106.14831006761068],
        [29.221549333892753, 106.15148538485126],
        [29.225369557832927, 106.15629127040457],
        [29.227129809141925, 106.16315682119503],
        [29.22915218818769, 106.1810072532501],
        [29.224770316441674, 106.19117685035845],
        [29.220238439901564, 106.20186136377606],
        [29.2158187308237, 106.21306079350293],
        [29.229788854806046, 106.22285530351074],
        [29.2409111563765, 106.23293987813771],
        [29.24454343078024, 106.24074944216186],
        [29.242858371056784, 106.25430890497293],
        [29.250160096125988, 106.26301957253831],
        [29.246303352422963, 106.26216137868948],
        [29.246715244606538, 106.23293987813771],
        [29.24701480151684, 106.2325966005982],
        [29.235855714557268, 106.22641518026545]
      ];
      this.my_ship_pos =
        [
          [28.866192228217155, 105.43162725795054],
          [28.86634256048012, 105.43347237472545],
          [28.866492892525635, 105.43475966549867],
          [28.86671839018621, 105.43604695627185],
          [28.86690630452963, 105.43731279219884],
          [28.867131801293237, 105.43862153781828],
          [28.867394880232464, 105.43988737374528],
          [28.867695541061845, 105.44123902905713],
          [28.867958618574047, 105.44239759075302],
          [28.868108948282032, 105.44359906214136],
          [28.8682029042391, 105.4446074399137],
          [28.868334442436314, 105.44550854345493],
          [28.86854114498125, 105.44651692122727],
          [28.86882301142543, 105.44752529899962],
          [28.869123668123272, 105.44864095100306],
          [28.8694243239513, 105.44967078362163],
          [28.869875306062436, 105.45035733870066],
          [28.87075847369419, 105.44975660300652],
          [28.871077915457242, 105.44864095100306],
          [28.87104033412432, 105.44758966353828],
          [28.870777264413306, 105.44666710515082],
          [28.87043903094913, 105.44565872737849],
          [28.870213541361412, 105.44465034960614],
          [28.870100796384072, 105.4437492460649],
          [28.869894096941245, 105.44278377798497],
          [28.869724978909506, 105.44175394536641],
          [28.869593442472308, 105.44070265790162],
          [28.86934916007585, 105.43965137043683],
          [28.869217623162967, 105.43870735720316],
          [28.869123668123272, 105.43750588581483],
          [28.869048504030374, 105.43673351135092],
          [28.868973339883077, 105.43593968204075],
          [28.868973339883077, 105.4353174915004],
          [28.868916966736947, 105.43463093642136],
          [28.86882301142543, 105.43398729103473],
          [28.868522353857795, 105.43327928110946],
          [28.868146530675073, 105.4323781775682],
          [28.867789497392643, 105.43164871279674],
          [28.867244549491588, 105.43156289341188]
        ];
    },

    init_icon: function () {
      var shipIcon = L.Icon.extend({
        options: {
          iconSize: [25, 25],
          iconAnchor: [0, 0],
          popupAnchor: [0, 0]
        }
      });

      var ship = new shipIcon({ iconUrl: 'src/assets/image/Boat.png' });

      for (let i = 0; i < 457; i++) {
        L.marker([this.ship_pos[i][0] + Math.random() * 0.0006,
        this.ship_pos[i][1] + Math.random() * 0.0006], {
          icon: ship,
        }).bindPopup("渔船ID：365021" + i
          + "<br />吃水：" + Math.round(20 + Math.random() * 85) + "吨"
          + "<br />速度：" + Math.round(5 + Math.random() * 5) + " km/h"
          + "<br />方向：" + Math.round(Math.random() * 360) + "° 顺时针"
          + "<br />经度：" + this.ship_pos[i][1]
          + "<br />纬度：" + this.ship_pos[i][0]
        ).addTo(this.map);
      }

    },

    init_my_ship: function () {
      var shipIcon = L.Icon.extend({
        options: {
          iconSize: [30, 30],
          iconAnchor: [0, 0],
          popupAnchor: [0, 0]
        }
      });

      var ship = new shipIcon({ iconUrl: 'src/assets/image/myship.png' });

      this.marker1 = L.marker(this.my_ship_pos[0], {
        icon: ship,
      }).bindPopup("渔船ID：365021"
        + "<br />吃水：" + 30 + "吨"
        + "<br />速度：" + 7 + " km/h"
        + "<br />方向：" + 62 + "° 顺时针"
        + "<br />经度：" + this.my_ship_pos[0][0]
        + "<br />纬度：" + this.my_ship_pos[0][1]
      ).addTo(this.map);
    },

    init_arrow: function () {
      var arrowIcon = L.Icon.extend({
        options: {
          iconSize: [40, 40],
          iconAnchor: [0, 0],
          popupAnchor: [0, 0]
        }
      });

      var arrow = new arrowIcon({ iconUrl: 'src/assets/image/right2.png' });

      let dx = this.my_ship_pos[1][1] - this.my_ship_pos[0][1];
      let dy = this.my_ship_pos[1][0] - this.my_ship_pos[0][0];
      let t = Math.atan2(dy, dx);
      if (t < 0) t += 2 * Math.PI;
      this.angle = 360 * t / (2 * Math.PI);

      const r = 0.0007;
      let a = r * Math.sin(t) + this.my_ship_pos[0][0];
      let b = r * Math.cos(t) + this.my_ship_pos[0][1];

      this.marker2 = L.marker(this.my_ship_pos[0], {
        icon: arrow,
      }).addTo(this.map).setRotationAngle(-this.angle).setLatLng([a, b]);
    },

    rightclick_callback: function (e) {
      if (this.picking == false) return;
      if (this.marker_group) {
        this.marker_group.clearLayers();
      }
      if (this.polyline_group) {
        this.map.removeLayer(this.polyline_group);
      }

      this.pick_points.pop();
      this.marker.pop();
      this.points.pop();

      this.marker_group = L.layerGroup(this.marker).addTo(this.map);
      if (this.points.length > 1) {
        this.polyline_group = L.polyline(this.points, { color: "red" }).addTo(this.map);
      }
    },

    end_plan: function () {
      this.picking = false;
      this.clear_plan();
    },
    begin_plan: function () {
      this.end_plan();
      this.picking = true;
    },
    clear_plan: function () {
      this.pick_points = [];
      this.marker = [];
      this.points = [];
      if (this.marker_group) {
        this.marker_group.clearLayers();
      }
      if (this.polyline_group) {
        this.map.removeLayer(this.polyline_group);
      }
    },
    cor_convert() {
      this.picking = false;
      return this.pick_points;
    },
    eventReady: function () {
      this.map.addEventListener('click', this.click_callback);
      this.map.addEventListener('contextmenu', this.rightclick_callback);
      this.emitter.on('beginPlan', event => { this.begin_plan(); })
      this.emitter.on('endPlan', event => { this.end_plan(); })
      this.emitter.on('clearPlan', event => { this.clear_plan(); })
      this.emitter.on('BMapSendPlan', event => { this.emitter.emit('Plan', this.cor_convert()); })
    }

  },
  unmounted() {
    this.emitter.emit('BMapLeave');
  }

});
</script>

<style scoped>
#map {
  width: 2000px;
  height: 800px;
  margin: 50px auto;
}
</style>
